import { createRequire as _createRequire } from 'node:module';
const require = _createRequire(import.meta.url);
import{a as Z,b as B,c as J,d as M,e as g,f as C,g as $}from"./chunk-RZNFFINS.js";import{f as k,i as G}from"./chunk-HRVSIFHF.js";import{b as d}from"./chunk-FACL5JC5.js";import{a as h,b as O}from"./chunk-RJJU2M3A.js";import"./chunk-H7EI5QTD.js";import{a as j}from"./chunk-N4QYMUI4.js";import"./chunk-CCZ55TG3.js";import{a as A}from"./chunk-3HFDZJBW.js";import"./chunk-XOWZQRGH.js";import{d as q,e as F,f as D}from"./chunk-NWEJ2BHT.js";import{b as I}from"./chunk-NX7YLKSA.js";import"./chunk-TISVPECQ.js";import"./chunk-4YVTD2GL.js";import"./chunk-Z2UWNMEU.js";import{c as w}from"./chunk-ZBJRW65P.js";import"./chunk-G3RJ67HQ.js";import{c as N}from"./chunk-XKUUBNP5.js";import"./chunk-KGVPDSRT.js";import"./chunk-KHHAS67O.js";import"./chunk-YXF3QNRI.js";import{i as L}from"./chunk-3JLE6D3G.js";import"./chunk-FCAB5YK5.js";import"./chunk-TEVFRW7G.js";import{a as Y,c as P,e as R}from"./chunk-JOXYEZYT.js";import{e as E,i as s}from"./chunk-UO4ZAUJK.js";s();s();import{URL as re}from"node:url";import{cwd as ie,exit as se}from"node:process";var _=E(Z(),1),W=E(Y(),1);s();s();var ee={},te={};function oe(o){var t={"bo._base_domain_":[{srcPath:"/_serverless/typok",destPath:""}],"cronulla-jobs._base_domain_":[{srcPath:"/serverless/typok",destPath:""}],"editor._base_domain_":[{srcPath:"/_serverless/typok",destPath:""}],"blocks._base_domain_":[{srcPath:"/_serverless/typok",destPath:""}],"create.editorx":[{srcPath:"/_serverless/typok",destPath:""}]};return q(Object.assign(o,{domainToMappings:t}))}function x(o){var t=D(ee,{}),l=t.toJSON,a=t.fromJSON,r=D(te,{}).fromJSON;function p(e){var m=e.host,y=l(o),c={entityFqdn:"wix.typok.v1.siterevision",method:"GET",methodFqn:"wix.typok.v1.SiteRevisionService.GetSiteRevision",url:oe({protoPath:"/v1/site-revision",data:y,host:m}),params:F(y),transformResponse:r};return c}return p.fromReq=a,p}x.__isAmbassador=!0;var z=async o=>{try{return(await h({type:"editor",authState:o.authState},x({}))).data?.siteRevision?.revision??null}catch(t){o.logger.logFailedToGetLatestRevision(t)}return null};var ae=o=>{let t=new re(o);return`${t.protocol}//${t.host}${t.pathname}`};async function le({biLogger:o,errorReporter:t},l){let a=await N(ie()),r=await j({metaSiteId:a.metaSiteId,biLogger:o,errorReporter:t}),p=A(),e=O({t:p}),m=await B(i=>I(L(a.projectFolder),i)),c=(l.source?{value:l.source}:await(0,_.default)({type:"select",name:"value",message:e.t("publish_command.prompt_what_to_publish"),choices:[{title:w.cyan(m?e.t("publish_command.prompt_what_to_publish_choice_remote",{branchName:m}):e.t("publish_command.prompt_what_to_publish_choice_remote_fallback")),value:"remote"},{title:w.cyan(e.t("publish_command.prompt_what_to_publish_choice_local")),value:"local"}]},{onCancel:()=>{e.logAborting(),se(130)}})).value==="local"?g.local():g.remote({}),v,b=e.logPreviewing();try{v=await C({model:a,operation:k.RC,source:c,authState:r}),b.success()}catch(i){if(G(i))b.stop(),e.logPreviewUnsupported();else throw b.fail(),i}let V=await z({authState:r,logger:e}),H=v?.deployedRevision??a.revision;if(e.logPublishRevision({branchName:m,isLocalDeployment:(0,W.isType)(c,g.local),currentRevision:H,latestRevision:V,preview:v}),(l.approvePreview?{value:!0}:await(0,_.default)({type:"confirm",name:"value",message:e.t("publish_command.prompt_continue_with_publish"),initial:!0})).value){let i=e.logDeploying(),T=v??await C({model:a,authState:r,operation:k.GA,source:c}),{deploymentId:U,deploymentUrl:K,isPublishPipelineDeployment:Q}=T,f;try{f=Q?await $({deploymentId:U,authState:r}):d.SUCCESS}catch(u){throw i.fail(),u}f===d.SUCCESS&&i.success();let S;if(f===d.ERROR){i.fail();try{let{data:n}=await h({type:"editor",authState:r},M({deploymentId:T.deploymentId,deploymentPipelinesIds:["5c696513-2584-4f19-ae0f-a559dd649482"]}),{retries:2});if(n.pipelinesDescription?.length){let{pipelinesDescription:X}=n;e.logPipelineErrorInformation({pipelinesDescription:X})}}catch(n){throw new P({code:R.FailedToGetPipelineErrorInfo(),cause:n})}e.logForceDeployWarning(),S=(l.force?{value:!0}:await(0,_.default)({type:"confirm",name:"value",message:p("publish_command.prompt_publish_with_error"),initial:!0})).value}if(f===d.SUCCESS||S){let u=e.logPublishing();try{await h({type:"editor",authState:r},J({deploymentId:U,skipPipelineCheck:S}),{retries:2})}catch(n){throw u.fail(),new P({code:R.FailedToPublishDeployment(),cause:n})}u.success({siteUrl:ae(K)})}}else e.logPublishAborted()}export{le as publish};
//# sourceMappingURL=publish-XRFPKDZ2.js.map
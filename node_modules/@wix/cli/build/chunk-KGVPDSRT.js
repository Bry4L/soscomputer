import { createRequire as _createRequire } from 'node:module';
const require = _createRequire(import.meta.url);
import{b as Pe,c as R,d as O}from"./chunk-KHHAS67O.js";import{a as xe,c as S,e as U,f as G,i as Be}from"./chunk-YXF3QNRI.js";import{k as I}from"./chunk-3JLE6D3G.js";import{b as z}from"./chunk-TEVFRW7G.js";import{f as Q,g as H}from"./chunk-JOXYEZYT.js";import{c as d,e as T,i as s}from"./chunk-UO4ZAUJK.js";var x=d((qt,_)=>{"use strict";s();var Fe=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(r){return typeof r}:function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r};function Le(r,t){if(!(r instanceof t))throw new TypeError("Cannot call a class as a function")}function Me(r,t){if(!r)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&(typeof t=="object"||typeof t=="function")?t:r}function Ne(r,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);r.prototype=Object.create(t&&t.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(r,t):r.__proto__=t)}var v=function(r){Ne(t,r);function t(e){Le(this,t);var n=Me(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.name=n.constructor.name,n}return t}(Error);function qe(r,t){if(r===void 0)throw new v(t)}function Ae(r,t){if(r!==void 0&&((typeof r>"u"?"undefined":Fe(r))!=="object"||Array.isArray(r)||r===null))throw new v(t)}function Ve(r,t){if(!r)throw new v(t)}function ze(r,t){if(r!==void 0&&typeof r!="function")throw new v(t)}function Qe(r,t){if(r!==void 0&&typeof r!="boolean")throw new v(t)}function He(r,t){if(r!==void 0&&typeof r!="number")throw new v(t)}function Ue(r,t){if(typeof Array.isArray=="function"){if(!Array.isArray(r))throw new v(t)}else if(Object.prototype.toString.call(r)!=="[object Array]")throw new v(t)}_.exports.defined=qe;_.exports.object=Ae;_.exports.ok=Ve;_.exports.func=ze;_.exports.boolean=Qe;_.exports.number=He;_.exports.array=Ue;_.exports.AssertionError=v});var Y=d((Vt,C)=>{"use strict";s();C.exports.mapValues=function(r,t){return r?Object.keys(r).reduce(function(e,n){return e[n]=t(r[n],n,r),e},{}):{}};C.exports.filterValues=function(r,t){return r?Object.keys(r).reduce(function(e,n){var i=t(r[n],n,r);return i&&(e[n]=r[n]),e},{}):{}}});var Z=d((Qt,j)=>{"use strict";s();j.exports.timedPromise=function(r,t){var e=t.message,n=t.timeout,i=new Promise(function(a,u){setTimeout(u,n,e?"Timeout: "+e:"Timeout")});return Promise.race([r,i])};j.exports.allAsObject=function(r){var t=Object.keys(r);return Promise.all(t.map(function(e){return r[e]})).then(function(e){return e.reduce(function(n,i,a){return n[t[a]]=i,n},{})})}});var K=d((Ut,$)=>{"use strict";s();$.exports={error:function(){if(console&&console.error){var t;(t=console).error.apply(t,arguments)}}}});var te=d((Rt,ee)=>{"use strict";s();function Ge(r,t,e){var n=void 0;return function(){var i=this,a=arguments,u=function(){n=null,e||r.apply(i,a)},o=e&&!n;clearTimeout(n),n=setTimeout(u,t),o&&r.apply(i,a)}}ee.exports=Ge});var ne=d((Jt,re)=>{"use strict";s();function Re(r,t){var e=void 0;return function(){for(var n=arguments.length,i=Array(n),a=0;a<n;a++)i[a]=arguments[a];e||(e=setTimeout(function(){r.apply(void 0,i),e=null},t))}}re.exports=Re});var B=d((Xt,ie)=>{"use strict";s();var Ie=function(){function r(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),t}}(),Je=function(){function r(t,e){var n=[],i=!0,a=!1,u=void 0;try{for(var o=t[Symbol.iterator](),c;!(i=(c=o.next()).done)&&(n.push(c.value),!(e&&n.length===e));i=!0);}catch(h){a=!0,u=h}finally{try{!i&&o.return&&o.return()}finally{if(a)throw u}}return n}return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return r(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),F=Object.assign||function(r){for(var t=1;t<arguments.length;t++){var e=arguments[t];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(r[n]=e[n])}return r};function We(r,t){if(!(r instanceof t))throw new TypeError("Cannot call a class as a function")}var Xe=te(),Ye=ne(),Ze=function(t,e,n){return{dt:Date.now()-n,f:t,context:e}},$e=function(t,e){return{dt:Date.now()-e,e:t,g:{}}},Ke=function(t){var e={},n=t.e.length,i=t.e.map(function(u){var o=Object.keys(u.f).map(function(c){var h=u.f[c],f=c+"|"+h;return e[f]=e[f]||0,e[f]++,[c,h,f]});return F({},u,{f:o})}),a={};return i=i.map(function(u){var o=u.f.reduce(function(c,h){var f=Je(h,3),y=f[0],g=f[1],b=f[2];return e[b]===n?a[y]=g:c[y]=g,c},{});return F({},u,{f:o})}),F({},t,{e:i,g:a})},et=function(){function r(){We(this,r),this._initilized=!1}return Ie(r,[{key:"_reset",value:function(){var e=this;this._startTime=Date.now(),this._resolve=null,this._promise=new Promise(function(n){return e._resolve=n})}},{key:"init",value:function(e,n){var i=this,a=e.delayMs,u=e.maxBatchSize,o=e.useThrottle,c=e.optimizeBatch;this._initilized||(this._maxBatchSize=u,this._optimizeBatch=c,this._queue=[],this._flushHandler=n,this._flushDebounced=o?Ye(function(){return i.flush()},a):Xe(function(){return i.flush()},a),this._initilized=!0,this._reset())}},{key:"flush",value:function(){if(!this._queue.length)return Promise.resolve();var e=this._queue.splice(0,this._queue.length),n=this._resolve,i=this._startTime;this._reset();var a=$e(e,i);return this._optimizeBatch&&(a=Ke(a)),this._flushHandler(a).then(n)}},{key:"feed",value:function(e,n){return this._queue.push(Ze(e,n,this._startTime)),this._queue.length===this._maxBatchSize?this.flush():(this._flushDebounced(),this._promise)}}]),r}();ie.exports=et});var oe=d((Zt,ue)=>{"use strict";s();var tt={functional:!0,analytics:!0,__default:!0},rt=function(t){return typeof t=="function"&&t()||tt},ae=function(t){return t.functional===!1||t.analytics===!1},nt=function(t,e){return e==="essential"?!1:e==="functional"||e==="analytics"?t[e]===!1:ae(t)};ue.exports={shouldMuteNonEssentials:ae,shouldMuteByCategory:nt,getPolicy:rt}});var M=d((Kt,de)=>{"use strict";s();var w=Object.assign||function(r){for(var t=1;t<arguments.length;t++){var e=arguments[t];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(r[n]=e[n])}return r},it=function(){function r(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),t}}();function at(r,t){var e={};for(var n in r)t.indexOf(n)>=0||Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n]);return e}function ut(r,t){if(!(r instanceof t))throw new TypeError("Cannot call a class as a function")}var D=x(),he=Y(),se=he.mapValues,le=he.filterValues,fe=Z(),ot=K(),st=B(),L=oe(),lt=L.shouldMuteByCategory,ce=L.shouldMuteNonEssentials,ft=L.getPolicy,ct=function(){function r(t,e){ut(this,r),this._publishers=t.publishers,this._validators=t.validators||[],this._defaults=t.defaults,this._ownDefaults={},this._events=t.events||{},this._context=e||{},this._defaultValueTimeout=t.defaultValueTimeout||5e3,this._defaultContinueOnFail=t.defaultContinueOnFail||!1,this._onPublisherFailHandler=t.onPublisherFailHandler||r._defaultPublisherFailHandler,this._isMuted=t.isMuted||function(){return!1},this._eventTransformer=t.eventTransformer||function(n){return n},this._payloadTransformer=t.payloadTransformer||function(n){return n},this._consentPolicyGetter=t.consentPolicyGetter||function(){return null},this._nonEssentialDefaults=t.nonEssentialDefaults||{},this._maxBatchSize=t.maxBatchSize||100,this._globalBatchQueue=t.globalBatchQueue}return it(r,[{key:"report",value:function(e){D.defined(e,"Data must be provided"),D.object(e,"Data must be an object");var n=e.src,i=e.evid,a=e.params,u=at(e,["src","evid","params"]);return this.log(w({src:n,evid:i},a),u)}},{key:"log",value:function(e,n,i){var a=this;D.defined(e,"Event object or event key must be provided.");var u=this._extractEventAndContext(e,n,i),o=u.event,c=u.context,h=ft(this._consentPolicyGetter),f=w({},this._context,c);if(this._isMuted()||lt(h,f.category))return Promise.resolve();if(f.useBatch){var y=this._initQueue(f,h),g=function(m){var P=a._eventTransformer(m,f);return y.feed(P,f)};if(this._globalBatchQueue)return this._getDefaults(this._defaults).then(function(E){var m=w({},E,a._getDynamicNonEssentialDefaults(h),a._getStaticNonEssentialDefaults(h),o,a._getPolicyFields(h,f.category));return g(m)});var b=w({},this._getDynamicDefaults(this._defaults),this._getDynamicNonEssentialDefaults(h),o,this._getPolicyFields(h,f.category));return g(b)}return this._getDefaults(this._defaults).then(function(E){var m=Object.assign(E,a._getDynamicNonEssentialDefaults(h),a._getStaticNonEssentialDefaults(h),o,a._getPolicyFields(h,f.category)),P=a._validators.length===0?!0:a._validators.some(function(V){return V.match(m)&&(V.execute(m)||!0)});if(!P)throw new Error("No validator accepted the event. Source: "+m.src+" Evid: "+(m.evid||m.evtId));var k=a._eventTransformer(m,f);return k=a._payloadTransformer(k,f),a._send(k,f)})}},{key:"flush",value:function(){return this._queue?this._queue.flush():Promise.resolve()}},{key:"updateDefaults",value:function(e){return D.defined(e,"Defaults must be provided"),D.object(e,"Defaults must be an object"),Object.assign(this._ownDefaults,e),this}},{key:"_send",value:function(e){var n=this,i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return Promise.all(this._publishers.map(function(a){var u=w({},e);return Promise.resolve().then(function(){return a(u,i)}).catch(function(o){return n._onPublisherFailHandler(o,{publisherName:a.name,payload:e})})})).then(function(){})}},{key:"_extractEventAndContext",value:function(e,n,i){var a=void 0,u={};if(typeof e!="string")a=e,u=n||u;else{if(a=this._events[e],!a)throw new D.AssertionError("Event with key '"+e+"' not found in event map.");n&&(a=w({},a,n),u=i||u)}return{event:a,context:u}}},{key:"_initQueue",value:function(e,n){var i=this;if(this._queue)return this._queue;this._queue=this._globalBatchQueue||new st;var a=function(o){i._globalBatchQueue||(o.g=Object.assign(i._getStaticDefaults(i._defaults),i._getStaticNonEssentialDefaults(n)));var c=i._payloadTransformer(o,e);return i._send(c,e)};return this._queue.init({delayMs:e.useBatch===!0?300:e.useBatch,maxBatchSize:this._maxBatchSize,useThrottle:!!this._globalBatchQueue,optimizeBatch:!!this._globalBatchQueue},a),this._queue}},{key:"_handleDefaultsError",value:function(e){return this._defaultContinueOnFail?(ot.error(e),null):Promise.reject(e)}},{key:"_getDynamicNonEssentialDefaults",value:function(e){if(!ce(e))return this._getDynamicDefaults(this._nonEssentialDefaults)}},{key:"_getStaticNonEssentialDefaults",value:function(e){if(!ce(e))return this._getStaticDefaults(this._nonEssentialDefaults)}},{key:"_withOwnDefaults",value:function(e){return Object.assign({},e,this._ownDefaults)}},{key:"_getDynamicDefaults",value:function(e){e=this._withOwnDefaults(e);var n=le(e,function(i){return typeof i=="function"});return se(n,function(i){return i()})}},{key:"_getStaticDefaults",value:function(e){e=this._withOwnDefaults(e);var n=le(e,function(i){return typeof i!="function"});return n}},{key:"_getDefaults",value:function(e){var n=this;if(e=this._withOwnDefaults(e),!e)return Promise.resolve({});var i=se(e,function(a,u){if(typeof a=="function")try{a=a()}catch(o){return n._handleDefaultsError(o)}return a&&typeof a.then=="function"?fe.timedPromise(a,{message:"Cannot get default value '"+u+" for BI Event'",timeout:n._defaultValueTimeout}).catch(function(o){return n._handleDefaultsError(o)}):a});return fe.allAsObject(i)}},{key:"_encodePolicyValue",value:function(e,n){return e?typeof e[n]=="boolean"?e[n]?1:0:e[n]:1}},{key:"_getPolicyFields",value:function(e,n){return{_isca:this._encodePolicyValue(e,"analytics"),_iscf:this._encodePolicyValue(e,"functional"),_ispd:e.__default?1:0,_ise:n==="essential"?1:0}}}],[{key:"_defaultPublisherFailHandler",value:function(e,n){var i=n.publisherName;return i}}]),r}();de.exports=ct});var N=d((tr,_e)=>{"use strict";s();var ht=function(){function r(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),t}}();function dt(r,t){if(!(r instanceof t))throw new TypeError("Cannot call a class as a function")}var me=x(),ve=function(){function r(){dt(this,r),this.reset()}return ht(r,[{key:"reset",value:function(){this._handlers=[]}},{key:"onLoggerCreated",value:function(e){var n=this;return me.defined(e,"Handler must be provided."),me.func(e,"Handler must be a function."),this._handlers.push(e),function(){var i=n._handlers.indexOf(e);i!==-1&&n._handlers.splice(i,1)}}},{key:"notifyLoggerCreated",value:function(e){this._handlers.forEach(function(n){return n(e)})}}]),r}();_e.exports={manager:new ve,BiLoggerManager:ve}});var ye=d((nr,ge)=>{"use strict";s();var mt=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(r){return typeof r}:function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},vt=function(){function r(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),t}}();function _t(r,t){if(!(r instanceof t))throw new TypeError("Cannot call a class as a function")}var l=x(),gt=M(),yt=N(),pt=B(),bt=function(){function r(){_t(this,r),this._publishers=[],this._validators=[],this._defaults={},this._nonEssentialDefaults={},this._events={},this._isMuted=!1,this._eventTransformer=null,this._payloadTransformer=null,this._consentPolicyGetter=null,this._maxBatchSize=null,this._batchQueue=null}return vt(r,[{key:"addPublisher",value:function(e){return l.defined(e,"Publisher must be provided"),l.ok(typeof e=="function","Expected a publisher function"),this._publishers.push(e),this}},{key:"addValidator",value:function(e){return l.defined(e,"Validator must be provided"),l.ok((typeof e>"u"?"undefined":mt(e))==="object"&&e,"Expected a validator object"),l.ok(e.execute&&e.match,"Provided validator does not match the interface"),this._validators.push(e),this}},{key:"setDefaults",value:function(e){return l.defined(e,"Defaults must be provided"),l.object(e,"Defaults must be an object"),this._defaults=e,this}},{key:"updateDefaults",value:function(e){return l.defined(e,"Defaults must be provided"),l.object(e,"Defaults must be an object"),Object.assign(this._defaults,e),this}},{key:"updateNonEssentialDefaults",value:function(e){return l.defined(e,"Non-essential Defaults must be provided"),l.object(e,"Non-essential Defaults must be an object"),Object.assign(this._nonEssentialDefaults,e),this}},{key:"setEvents",value:function(e){return l.defined(e,"Events must be provided"),l.object(e,"Events must be an object"),this._events=e,this}},{key:"setDefaultValueTimeout",value:function(e){return l.defined(e,"Default Value Timeout must be provided"),this._defaultValueTimeout=e,this}},{key:"setDefaultContinueOnFail",value:function(e){return l.defined(e,"Default Continue On Fail must be provided"),this._defaultContinueOnFail=e,this}},{key:"setPublisherFailHandler",value:function(e){return l.defined(e,"Publisher Fail Handler must be provided"),this._onPublisherFailHandler=e,this}},{key:"setMuted",value:function(e){return l.defined(e,"Is Muted must be provided"),l.boolean(e,"Is Muted must be a boolean"),this._isMuted=e,this}},{key:"setMaxBatchSize",value:function(e){return l.defined(e,"Max Batch Size must be provided"),l.number(e,"Max Batch Size must be a number"),l.ok(e>0,"Max Batch Size must be higher than 0"),this._maxBatchSize=e,this}},{key:"setGlobalBatchQueue",value:function(e){return l.defined(e,"Global Batch Queue must be provided"),l.ok(e instanceof pt,"Global Batch Queue must be an instance of BatchQueue"),this._globalBatchQueue=e,this}},{key:"withEventTransformer",value:function(e){return l.defined(e,"Event Transformer must be provided"),l.func(e,"Event Transformer must be a function"),this._eventTransformer=e,this}},{key:"withPayloadTransformer",value:function(e){return l.defined(e,"Payload Transformer must be provided"),l.func(e,"Payload Transformer must be a function"),this._payloadTransformer=e,this}},{key:"withConsentPolicyGetter",value:function(e){return l.defined(e,"Consent Policy Getter must be provided"),l.func(e,"Consent Policy Getter must be a function"),this._consentPolicyGetter=e,this}},{key:"logger",value:function(e){var n=this,i=new gt({publishers:this._publishers,validators:this._validators,defaults:this._defaults,events:this._events,defaultValueTimeout:this._defaultValueTimeout,defaultContinueOnFail:this._defaultContinueOnFail,onPublisherFailHandler:this._onPublisherFailHandler,isMuted:function(){return n._isMuted},eventTransformer:this._eventTransformer,payloadTransformer:this._payloadTransformer,consentPolicyGetter:this._consentPolicyGetter,nonEssentialDefaults:this._nonEssentialDefaults,maxBatchSize:this._maxBatchSize,globalBatchQueue:this._globalBatchQueue},e);return yt.manager.notifyLoggerCreated(i),i}}]),r}();ge.exports=bt});var we=d((ar,p)=>{"use strict";s();var pe=ye(),wt=M(),be=N(),Dt=B();p.exports.BiLoggerFactory=pe;p.exports.BiLogger=wt;p.exports.BiLoggerManager=be.BiLoggerManager;p.exports.factory=function(){return new pe};p.exports.manager=be.manager;p.exports.createBatchQueue=function(){return new Dt}});s();import{uptime as Ce}from"node:process";s();var J=T(xe(),1);import ke from"node:os";import{platform as Te,version as Se}from"node:process";function W({cliVersion:r,flow:t}){return{...t?{flow:t}:{},cliVersion:r,isCI:J.default,nodeVersion:Se,osName:Oe(),osVersion:ke.release()}}function Oe(){switch(Te){case"darwin":return"mac";case"win32":return"windows";default:return"linux"}}var X=()=>Math.round(Ce()*1e3);function je({biLogger:r,command:t,flow:e,cliVersion:n,projectId:i,extensions:a}){let u={command:t.name(),arguments:t.args.join(",")??"",flags:Object.keys(t.opts()).join(",")};return r.report(R({...W({cliVersion:n,flow:e}),...u,...i?{projectId:i}:{},isValid:!0})),{succeed(){r.report(O({...u,...a?{extensions:JSON.stringify(a)}:{},duration:X(),isSuccess:!0,isValid:!0}))},failed(o){let c=Q(o)?{errorType:H(o)?"SystemError":"UserError",errorName:o.name,errorMessage:o.message}:o instanceof Error?{errorType:"UnknownError",errorName:o.name,errorMessage:o.message}:{errorType:"UnknownError",errorMessage:JSON.stringify(o)};r.report(O({...u,...c,...a?{extensions:JSON.stringify(a)}:{},duration:X(),isSuccess:!1,isValid:!0}))}}}s();s();s();Be();var De=T(we()),Ee=T(Pe()),Et={baseUrl:process.env.BI_BASE_URL||"https://frog.wix.com",endpoint:"",logError:!1},q=function(){function r(){}return r.prototype.factory=function(t){var e=this;t===void 0&&(t={});var n=S(S({},Et),t),i=De.default.factory();return n.onError&&i.setPublisherFailHandler(n.onError),i.addPublisher(function(a,u){return U(e,void 0,void 0,function(){var o,c,h,f,y;return G(this,function(g){switch(g.label){case 0:return o=u.endpoint||n.endpoint,c=n.baseUrl,h=n.userAgent,f=n.logError,y=h?{headers:{"User-Agent":h}}:{},[4,new Ee.HttpClient({baseURL:c}).get(o,{headers:y,params:a,timeout:30*1e3}).catch(function(b){return f?console.error(b.toJSON()):Promise.reject(b)})];case 1:return g.sent(),[2]}})})}),i},r}();var sr=new q;s();import{randomUUID as xt}from"node:crypto";function Bt(r,t){r.updateDefaults(A(t))}function A(r){return r?{_client_id:r,_uuid:r,logged_user_id:r,logged_account_id:r,target_account_id:r}:{_client_id:xt()}}async function Pt(r,t){let e=z().biLoggerBaseUrl,n=e?{baseUrl:e}:{},i=A(t),{telemetry:a}=await I();return new q().factory(n).updateDefaults({localTime:()=>Date.now(),...r,...i}).setMuted(!a).logger()}export{Bt as a,Pt as b,je as c};
//# sourceMappingURL=chunk-KGVPDSRT.js.map